<html>

    <head>
        <title>cicd</title>
        <script src="/static/js/jquery.min.js" type="text/javascript" ></script>
    </head>
    <style>
    table
    {
        border-collapse: collapse;
        /*margin: 0 auto;*/
        text-align: left;
    }
    table td, table th
    {
        border: 1px solid #cad9ea;
        color: #666;
        height: 30px;
    }
    table thead th
    {
        background-color: #CCE8EB;
        width: 100px;
    }
    table tr:nth-child(odd)
    {
        background: #fff;
    }
    table tr:nth-child(even) {
        background: #F5FAFA;
    }

    .portlet {
        border:1px solid #ff0000;
        margin:5px;
    }

    </style>

<body>

server service superVisor :<br/>
<div id="server_service_super_visor">

</div>




server:<br/>
<table class='table' id="table_server_list">

</table>
<br/>

service:<br/>
<table class='table' id="table_service_list">

</table>
<br/>

instance:<br/>
<table class='table' id="table_instance_list">

</table>
<br/>

publish:<br/>
<table class='table' id="table_publish_list">

</table>
<b/>





<script>
    // 后端公共HTTP接口-头信息
    var header_X_Source_Type = "11";
    var header_X_Project_Id = "6";
    var header_X_Access = "imzgoframe";
    //===========================
    var serviceList = null;
    var serverList = null;
    var instanceList = null;
    var publishList = null;

    var server_ping_status_desc = {1:"正常",2:"关闭"};
    var super_visor_status_desc = {0:"正常",1:"初始化失败",2:"XMLRpc连接失败"}
    var deployStatus = {0:"否",1:"是"};

    $(document).ready(function(){
        $.ajax({
            headers: {
                "X-Source-Type": header_X_Source_Type,
                "X-Project-Id": header_X_Project_Id,
                "X-Access": header_X_Access,
            },
            type: "GET",
            contentType: "application/json;charset=utf-8",
            url: "/cicd/service/list",
            success: function(backData){
                backData = eval(   backData  );
                if(backData.code != 200){
                    return alert("ajax req back data err");
                }
                // serverList =  $.parseJSON(backData)
                serviceList =  backData.data;
                ProcessServiceList("table_service_list",serviceList)

            }
        });
    });

    $(document).ready(function(){
        $("#table_server_list").html("server 正在 ping 中，略慢，请等待...")
        $.ajax({
            headers: {
                "X-Source-Type": header_X_Source_Type,
                "X-Project-Id": header_X_Project_Id,
                "X-Access": header_X_Access,
            },
            type: "GET",
            contentType: "application/json;charset=utf-8",
            url: "/cicd/server/list",
            success: function(backData){
                backData = eval(   backData  );
                if(backData.code != 200){
                    return alert("ajax req back data err");
                }
                serverList =  backData.data;
                ProcessList("table_server_list",serverList)

            }
        });
    });


    // $(document).ready(function(){
    //     $.ajax({
    //         type: "GET",
    //         contentType: "application/json;charset=utf-8",
    //         url: "/getInstanceList",
    //         success: function(backData){
    //             instanceList = $.parseJSON(backData)
    //             ProcessList("table_instance_list",instanceList)
    //         }
    //     });
    // });
    //
    // $(document).ready(function(){
    //     $.ajax({
    //         type: "GET",
    //         contentType: "application/json;charset=utf-8",
    //         url: "/getPublishList",
    //         success: function(backData){
    //             publishList = $.parseJSON(backData)
    //             ProcessPublishList("table_publish_list",publishList)
    //         }
    //     });
    // });
    //
    // $(document).ready(function(){
    //     $.ajax({
    //         type: "GET",
    //         contentType: "application/json;charset=utf-8",
    //         url: "/getServiceList",
    //         success: function(backData){
    //             serviceList =  $.parseJSON(backData)
    //             ProcessServiceList("table_service_list",serviceList)
    //         }
    //     });
    // });
    //
    $(document).ready(function(){
        $.ajax({
            headers: {
                "X-Source-Type": header_X_Source_Type,
                "X-Project-Id": header_X_Project_Id,
                "X-Access": header_X_Access,
            },
            type: "GET",
            contentType: "application/json;charset=utf-8",
            url: "/cicd/superVisor/list",
            success: function(backData){
                backData = eval(   backData  );
                if(backData.code != 200){
                    return alert("ajax req back data err");
                }
                ProcessServerService( backData.data)
            }
        });
    });
    //
    //
    // function GetOptBnt(){
    //     var optBnt = "<a href='#'>停止</a>&nbsp;";
    //     optBnt += "<a href='#'>重启</a>&nbsp;";
    //     optBnt += "<a href='#'>启动</a>&nbsp;";
    //     optBnt += "<a href='#'>部署代码</a>&nbsp;";
    //     optBnt += "<a href='#'>发布代码</a>&nbsp;";
    //     optBnt += "<a href='#'>回滚</a>&nbsp;";
    //
    //     return optBnt;
    // }

    function GetServiceOptBnt(){
        var optBnt = "<a href='#'>停止</a>&nbsp;";
        optBnt += "<a href='#'>重启</a>&nbsp;";
        optBnt += "<a href='#'>启动</a>&nbsp;";
        optBnt += "<a href='#'>部署代码</a>&nbsp;";
        optBnt += "<a href='#'>发布代码</a>&nbsp;";
        optBnt += "<a href='#'>回滚</a>&nbsp;";

        return optBnt;
    }



    function ProcessServerService(serverService){
        var server_ping_status = serverService.server_ping_status;
        var super_visor_status = serverService.super_visor_status;

        var serviceSuperVisorList = serverService.server_service_super_visor;
        var tableHtml = "<table><th>server_id</th><th>ping_status</th><th>super_visor_status</th><th>env</th><th>service_super_visor</th>";

        for(let serverId  in server_ping_status){
            var status = server_ping_status[serverId];
            var sv_status = super_visor_status[serverId]

            var tr = "<tr><td>"+serverId+"</td><td>"+server_ping_status_desc[status]+"</td><td>"+super_visor_status_desc[sv_status]+"</td><td>"+serverList[serverId].env+"</td>";
            if (status != 1){
                // alert("server status err.");
                tr +="<td></td></tr>";
                tableHtml += tr;
                continue;
            }

            if  (sv_status){
                // alert("super_visor_status status err.");
                tr +="<td></td></tr>";
                tableHtml += tr;
                continue;
            }

            tr += "<td>";
            var serviceSuperVisor = serviceSuperVisorList[serverId];
            console.log("serviceSuperVisor:",serviceSuperVisor);
            var processListTable = "<table>";

            for(var i=0;i<serviceSuperVisor.length;i++){
                var bnt = GetBnt(serviceSuperVisor[i].State);
                processListTable += "<tr><td>"+serviceSuperVisor[i].Name+"</td><td>"+serviceSuperVisor[i].State+"</td><td>&nbsp;</td><td>"+bnt+"</td></tr>";
            }
            processListTable += "</table>";

            tr += processListTable;
            tr += "</td>";
            tableHtml += tr;

        }

        tableHtml += "</table>";

        $("#server_service_super_visor").html(tableHtml);
    }

    function GetBnt(superVisorState ){
        var optBnt = "<a href='#'>部署</a>&nbsp;";
        if (superVisorState == 999){
            return optBnt;
        }else if (superVisorState === 0 || superVisorState == 30 || superVisorState == 100 || superVisorState == 200){
            optBnt += "<a href='#'>启动</a>&nbsp;"
        }else if (superVisorState == 20 ){
            optBnt += "<a href='#'>停止</a>&nbsp;"
            optBnt += "<a href='#'>重启</a>&nbsp;"
            return optBnt;
        }else if (superVisorState == 10 ){
            optBnt = "<a href='#'>启动中,请等待</a>&nbsp;"
            return optBnt;
        }else if (superVisorState == 40 ){
            optBnt = "<a href='#'>停止中,请等待</a>&nbsp;"
            return optBnt;
        }else{
            optBnt = "<a href='#'>未知状态</a>&nbsp;"
            return optBnt;
        }
        optBnt += "<a href='#'>发布</a>&nbsp;";
        optBnt += "<a href='#'>回滚</a>&nbsp;";
        return optBnt
    }

    function ProcessServiceList(objId,data_list){
        var tableObj = $("#"+objId);
        // alert(servier_list[0]);
        // var server_list =
        var tableTh = "";

        var server_list_first_key = 0;
        var trTdAll = "";
        for(let key  in data_list){
            server_list_first_key = key;
            var trTd = "<tr>";
            for(let key2  in data_list[key]){
                if (key2 == "deploy"){
                    trTd += "<td>"+ deployStatus[data_list[key][key2]]+ "</td>";
                }else{
                    trTd += "<td>"+data_list[key][key2]+ "</td>";
                }
            }
            trTd += "<td><a href='#'>"+GetServiceOptBnt()+"</a></td></tr>"
            trTdAll += trTd;
        }

        for(let key  in data_list[server_list_first_key]){
            tableTh += "<th>"+key+"</th>";
        }

        tableTh += "<th></th>";

        // alert(trTdAll);
        // var html = tableTh + trTdAll;
        // alert(html);
        // $("#table_server_list").html(html);
        tableObj.append(tableTh);
        tableObj.append(trTdAll);
    }
    //
    // function ProcessPublishList(objId,data_list){
    //     var tableObj = $("#"+objId);
    //     // alert(servier_list[0]);
    //     // var server_list =
    //     var tableTh = "";
    //
    //     var server_list_first_key = 0;
    //     var trTdAll = "";
    //     for(let key  in data_list){
    //         server_list_first_key = key;
    //         var trTd = "<tr>";
    //         for(let key2  in data_list[key]){
    //             trTd += "<td>"+data_list[key][key2]+ "</td>";
    //         }
    //         trTd += "<td><a href='#'>取消发布</a>&nbsp;<a href='#'>重新发布</a></td></tr>"
    //         trTdAll += trTd;
    //     }
    //
    //     for(let key  in data_list[server_list_first_key]){
    //         tableTh += "<th>"+key+"</th>";
    //     }
    //
    //     tableTh += "<th></th>";
    //
    //     // alert(trTdAll);
    //     // var html = tableTh + trTdAll;
    //     // alert(html);
    //     // $("#table_server_list").html(html);
    //     tableObj.append(tableTh);
    //     tableObj.append(trTdAll);
    // }
    //
    //
    function ProcessList(objId,data_list){
        var tableObj = $("#"+objId);
        tableObj.html("");
        // alert(servier_list[0]);
        // var server_list =
        var tableTh = "";

        var server_list_first_key = 0;
        var trTdAll = "";

        for(let key  in data_list){
            server_list_first_key = key;
            var trTd = "<tr>";
            for(let key2  in data_list[key]){
                trTd += "<td>"+data_list[key][key2]+ "</td>";
            }
            trTd += "</tr>"
            trTdAll += trTd;
        }

        for(let key  in data_list[server_list_first_key]){
            tableTh += "<th>"+key+"</th>";
        }

        // alert(trTdAll);
        // var html = tableTh + trTdAll;
        // alert(html);
        // $("#table_server_list").html(html);
        tableObj.append(tableTh);
        tableObj.append(trTdAll);
    }

</script>

</body>

</html>