<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>frame_sync-帧同步 demo</title>
</head>
<body>

<style>
    .div_block{
        border:1px solid #000;
        width:30px;
        height:30px;
    }
</style>
<div  >
    <table id="server_config_table" style="display:inline" >

    </table>
    <table id="local_config_table"  style="display:inline">
    </table>
</div>

<script src="/static/js/jquery.min.js" type="text/javascript"></script>
<!--每个玩家的长连接操作-公共类库-->
<script src="/static/js/sync.js?r=6" type="text/javascript"></script>
<!--强依赖，proto 文件，因为它已经定义好对象结构了，直接复用，保持前后端接口数据格式一致-->
<!--这里用到了两个.proto文件，1.网关(长连接，封/拆包) 2. 帧同步-->
<script src="/static/js/pb/gateway_pb.js" type="text/javascript"></script>
<script src="/static/js/pb/frame_sync_pb.js?r=1" type="text/javascript"></script>



<!--玩家列表 开始-->
<div id="p1" style="float: left;border:1px solid #cad9ea;"></div>
<div id="p2" style="border:1px solid #cad9ea" ></div>

<br/><br/>

<div id="p3" style="float: left;border:1px solid #cad9ea"></div>
<div id="p4" style="border:1px solid #cad9ea"></div>
<!--玩家列表 结束-->

<br/><br/>
<br/><br/>
</body>

<script type="text/javascript">

</script>

<script type="text/javascript">
    // 后端公共HTTP接口-头信息
    var header_X_Source_Type = "11";
    var header_X_Project_Id = "6";
    var header_X_Access = "imzgoframe";
    //长连接 通信协议 基础类型 定义
    var contentTypeDesc = {1:"json",2:"protobuf"};
    var protocolTypeDesc = {1:"tcp",2:"websocket",3:"udp"};

    //后端HTTP URL 相关
    var domain = window.location.host;
    //S端配置信息,IP 端口 协议类型
    var serverHostUri = "http://"+domain + "/gateway/config";
    //通讯协议的协议号
    var actionMapHostUri = "http://"+domain + "/gateway/action/map";
    var loginUrl = "http://"+domain + "/base/login"
    //用户名公共前缀
    var playerNamePrefix = "frame_sync_"
    //一共几个玩家参与到游戏中
    var playerMax = 4;

    var playerList ={
        "frame_sync_1":{id:1,"username":"frame_sync_1","pawword":"123456","info":{},"token":""},
        "frame_sync_2":{id:2,"username":"frame_sync_2","pawword":"123456","info":{},"token":""},
        "frame_sync_3":{id:3,"username":"frame_sync_3","pawword":"123456","info":{},"token":""},
        "frame_sync_4":{id:4,"username":"frame_sync_4","pawword":"123456","info":{},"token":""},
    }

    var contentType = 1;//长连接 - 传输内容类型
    var protocolType = 2;//长连接 - 协议 类型
    //各种html div id 前缀，主要是方便sync.js控制页面UI变化
    var domIdPre = {
        "seq":"seqId_",
        "map":"mapId_",
        "room":"roomId_",
        "optBnt":"optBntId_",
        "randSeek":"randSeekId_",
        "moveUp":"moveUp_",
        "moveLeft":"moveLeft_",
        "moveRight":"moveRight_",
        "moveDown":"moveDown_",
    };

    function GetPlayerNameByIndex(index){
        return playerNamePrefix + index;
    }


    function init(){
        showLocalConfig();
        playerLogin();//玩家登陆，初始化信息 name token
        initServerConfig();//获取 后端 连接相关信息, 非异步
        initActionMap();//获取 长连接 接口ID 号等，用于映射, 非异步

        //基础信息，获取结束，开始 初始化 玩家同步相关信息
        for (var i=1;i<=playerMax;i++){
            var playerInfo = playerList[GetPlayerNameByIndex(i)];
            initPlayer(playerInfo,"p"+i,ServerConfig);
        }
    }

    function showLocalConfig(){
        var html = "";
        html += "<tr><td>playerMax</td><td>"+ playerMax +"人</td></tr>";
        $("#local_config_table").html(html);
    }

    var ServerConfig = {};
    function initServerConfig(){
        $.ajax({
            type: "GET",
            async:false,
            headers: {
                "X-Token":playerList[GetPlayerNameByIndex(1)].token,
            },
            url:serverHostUri,
            success: function(data){
                // alert(data.code);
                processHtml(data.data);
                ServerConfig = data.data;
            }
        });

        function processHtml (data){``

            var showServerCfg = ["outIp","wsUri","wsPort","offLineWaitTime","matchGroupPeople","fps","roomReadyTimeout","connTimeout"]
            var html = "";
            for(let key  in data){
                for(var i=0;i<showServerCfg.length;i++){
                    if (key == showServerCfg[i]){
                        html += "<tr><td>"+key+"</td><td>"+data[key]+"</td>";
                    }
                }
            }

            html += "<tr><td>contentType</td><td>"+ contentTypeDesc[contentType] +"</td></tr>";
            html += "<tr><td>protocolType</td><td>"+ protocolTypeDesc[protocolType]+"</td></tr>";

            var serverConfigTable = $("#server_config_table");
            serverConfigTable.html(html);
        }
    }


    function initActionMap(){
        $.ajax({
            async:false,
            type: "GET",
            headers: {
                "X-Token":playerList[GetPlayerNameByIndex(1)].token,
            },
            url:actionMapHostUri,
            success: function(dataActionMap){
                ServerConfig.actionMap = dataActionMap.data;
            }
        });
    }
    //初始化一个玩家的场景
    function initPlayer(player,divId,data){
        //创建一个玩家相关的所有DIV的ID，主要是ID 是由前缀+PID 动态生成 的
        var DomIdPreObj = getPlayerDomIdPreObj(player.id);
        DomIdPreObj.playerId = player.id;

        var wsObj = new Sync(player.id, player.token, data, DomIdPreObj,contentType,protocolType);

        var html = getTemplateHtml();
        html = ReplaceTemplateHtml(html,DomIdPreObj);
        $("#"+divId).html(html);
        $("#"+DomIdPreObj.optBntId).click(wsObj.create);

        $("#"+DomIdPreObj.moveUp).click("up",wsObj.move);
        $("#"+DomIdPreObj.moveLeft).click("left",wsObj.move);
        $("#"+DomIdPreObj.moveRight).click("right",wsObj.move);
        $("#"+DomIdPreObj.moveDown).click("down",wsObj.move);

        wsObj.getMap("mapId_"+player.id);
    }

    function getPlayerDomIdPreObj(pid){
        var rrVV = {
            "seqId":domIdPre.seq+pid,
            "roomId":domIdPre.room+pid,
            "mapId":domIdPre.map +pid,
            "optBntId":domIdPre.optBnt+pid,
            "randSeekId":domIdPre.randSeek+pid,
            "moveUp":domIdPre.moveUp+pid,
            "moveLeft":domIdPre.moveLeft+pid,
            "moveRight":domIdPre.moveRight+pid,
            "moveDown":domIdPre.moveDown+pid,
        };
        return rrVV;
    }

    function ReplaceTemplateHtml(html,DomIdPreObj){
        for(let key  in DomIdPreObj){
            html = html.replace("{{"+key +"}}",DomIdPreObj[key]);
        }
        return html;
    }

    function getTemplateHtml(){
        var html  = '<table>\n' +
            '    <tr>\n' +
            '        <td>seqId:<span id="{{seqId}}"></span></td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td>roomId：<span id="{{roomId}}" ></span></td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td>randSeek：<span id="{{randSeekId}}" ></span></td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td>绿色:自己</td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td>红色:对方</td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td width="50%">\n' +
            '            <div>\n' +
            '                player_{{playerId}}\n' +
            '            </div>\n' +
            '            <table id="{{mapId}}"></table>\n' +
            '\n' +
            '            <table>\n' +
            '                <tr>' +
            '                   <td></td>' +
            '                   <td id="{{moveUp}}"><a href="javascript:void(0)"  >上</a></td><td></td>' +
            '                </tr>\n' +
            '                <tr>' +
            '                   <td id="{{moveLeft}}"><a href="javascript:void(0)"  >左</a></td><td></td>' +
            '                   <td id="{{moveRight}}"><a href="javascript:void(0)"  >右</a></td>' +
            '                </tr>\n' +
            '                <tr>' +
            '                   <td></td>' +
            '                   <td id="{{moveDown}}"><a href="javascript:void(0)"  >下</a></td><td></td>' +
            '                </tr>\n' +
            '            </table>\n' +
            '\n' +
            '            <div>\n' +
            '                <div id="{{optBntId}}">\n' +
            '                    <a href="javascript:void(0);">连接</a>\n' +
            '                </div>\n' +
            '\n' +
            '            </div>\n' +
            '        </td>\n' +
            '\n' +
            '    </tr>\n' +
            '</table>';
        return html;
    }

    //玩家登陆，初始化信息 name token
    function playerLogin(){
        for (var i=1;i<=playerMax;i++){
            ajaxLogin(i)
        }
    }

    function ajaxLogin(player_index){
        var username = GetPlayerNameByIndex(player_index);
        $.ajax({
            headers: {
                "X-Source-Type": header_X_Source_Type,
                "X-Project-Id": header_X_Project_Id,
                "X-Access": header_X_Access,
            },
            type: "POST",
            data : {"username":username,"password":"123456"},
            url:loginUrl,
            dataType: "json",
            success: function(data){
                if (data.code != 200){
                    return alert("login server back err:"+data.msg);
                }

                var username = data.data.user.username;
                playerList[username].info = data.data.user;
                playerList[username].token = data.data.token;

            }
        });
    }

    init();

</script>


</html>