<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WS-DEMO</title>
</head>
<body>

<style>
    .div_block{
        border:1px solid #000;
        width:30px;
        height:30px;
    }
</style>

S端配置信息
<table id="server_config_table">

</table>

<script src="/static/js/jquery.min.js" type="text/javascript"></script>
<!--每个玩家的长连接操作-->
<script src="/static/js/sync.js?r=3" type="text/javascript"></script>
<!--强依赖，proto 文件，因为它已经定义好对象结构了，直接复用-->
<!--<script src="/static/js/pb/common_pb.js?r=2" type="text/javascript"></script>-->
<script src="/static/js/pb/gateway_pb.js" type="text/javascript"></script>
<script src="/static/js/pb/frame_sync_pb.js?r=1" type="text/javascript"></script>



<!--玩家列表 开始-->
<div id="p1" style="float: left;border:1px solid #cad9ea;"></div>
<div id="p2" style="border:1px solid #cad9ea" ></div>

<br/><br/>

<div id="p3" style="float: left;border:1px solid #cad9ea"></div>
<div id="p4" style="border:1px solid #cad9ea"></div>
<!--玩家列表 结束-->

<br/><br/>
<br/><br/>
</body>

<script type="text/javascript">

</script>

<script type="text/javascript">
    var header_X_Source_Type = "11";
    var header_X_Project_Id = "6";
    var header_X_Access = "imzgoframe";

    var contentTypeDesc = {1:"json",2:"protobuf"};
    var protocolTypeDesc = {1:"tcp",2:"websocket",3:"udp"};


    var domain = window.location.host;
    var serverHostUri = "http://"+domain + "/gateway/config";//S端配置信息,IP 端口 协议类型
    var actionMapHostUri = "http://"+domain + "/gateway/action/map";//通讯协议的协议号
    var loginUrl = "http://"+domain + "/base/login"

    var playerNamePrefix = "frame_sync_"

    var playerMax = 4;

    var playerList ={
        "frame_sync_1":{id:1,"username":"frame_sync_1","pawword":"123456","info":{},"token":""},
        "frame_sync_2":{id:2,"username":"frame_sync_2","pawword":"123456","info":{},"token":""},
        "frame_sync_3":{id:3,"username":"frame_sync_3","pawword":"123456","info":{},"token":""},
        "frame_sync_4":{id:4,"username":"frame_sync_4","pawword":"123456","info":{},"token":""},
    }

    var contentType = 1;
    var protocolType = 2;
    //各种html div id 前缀，主要是方便sync.js控制页面UI变化
    var domIdPre = {
        "seq":"seqId_",
        "map":"mapId_",
        "room":"roomId_",
        "optBnt":"optBntId_",
        "randSeek":"randSeekId_",
        "moveUp":"moveUp_",
        "moveLeft":"moveLeft_",
        "moveRight":"moveRight_",
        "moveDown":"moveDown_",
    };

    function GetPlayerNameByIndex(index){
        return playerNamePrefix + index;
    }

    function playerLogin(){
        for (var i=1;i<=playerMax;i++){
            ajaxLogin(i)
        }
    }

    function ajaxLogin(player_index){
        var username = GetPlayerNameByIndex(player_index);
        $.ajax({
            headers: {
                "X-Source-Type": header_X_Source_Type,
                "X-Project-Id": header_X_Project_Id,
                "X-Access": header_X_Access,
            },
            type: "POST",
            data : {"username":username,"password":"123456"},
            url:loginUrl,
            dataType: "json",
            success: function(data){
                if (data.code != 200){
                    return alert("login server back err:"+data.msg);
                }

                var username = data.data.user.username;
                playerList[username].info = data.data.user;
                playerList[username].token = data.data.token;

            }
        });
    }



    // var player1 = {"id":1,"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVaWQiOjEsIkV4cGlyZSI6MTYxNzMyOTk2MywiQVRpbWUiOjE2MTcyNDM1NjMsIkFwcElkIjoxfQ.XxbHWdSZx4WvXklXHfCWjSpJAIZo2aVv4aUuD3SNsIE"};
    // // var player2 = {"id":2,"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVaWQiOjEsIkV4cGlyZSI6MTYxNzMyOTk2MywiQVRpbWUiOjE2MTcyNDM1NjMsIkFwcElkIjoxfQ.XxbHWdSZx4WvXklXHfCWjSpJAIZo2aVv4aUuD3SNsIE"};
    // var player2 = {"id":2,"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVaWQiOjIsIkV4cGlyZSI6MTYxNzc5NzUyMSwiQVRpbWUiOjE2MTc3MTExMjEsIkFwcElkIjoxfQ.vKWg0rKfanCZEWBoR4WfuHBAPj5-cH_AxY21YO_RUlk"};
    // var player3 = {"id":3,"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVaWQiOjMsIkV4cGlyZSI6MTYxODQ1ODI1NywiQVRpbWUiOjE2MTgzNzE4NTcsIkFwcElkIjoxfQ.cUQcIdUGsExH4nrzQ49QPvxvPwZJ1N30OP9Sn9KX300"};
    // var player4 = {"id":4,"token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVaWQiOjQsIkV4cGlyZSI6MTYxODQ1ODI5NSwiQVRpbWUiOjE2MTgzNzE4OTUsIkFwcElkIjoxfQ.5pgyy2Pn13q9nwTbP4_CGBNxUnDHUCNDwFHOdwDt1ck"};
    //
    var ServerConfig = {};
    function initServerConfig(){
        $.ajax({
            type: "GET",
            headers: {
                "X-Token":playerList[GetPlayerNameByIndex(1)].token,
            },
            url:serverHostUri,
            success: function(data){
                // alert(data.code);
                processHtml(data.data);
                ServerConfig = data.data;

                initActionMap()
            }
        });

        function processHtml (data){``

            var showServerCfg = ["outIp","wsUri","wsPort","offLineWaitTime","matchGroupPeople","fps","roomReadyTimeout","connTimeout"]
            var html = "";
            for(let key  in data){
                for(var i=0;i<showServerCfg.length;i++){
                    if (key == showServerCfg[i]){
                        html += "<tr><td>"+key+"</td><td>"+data[key]+"</td>";
                    }
                }
            }

            html += "<tr><td>contentType</td><td>"+ contentTypeDesc[contentType] +"</td></tr>";
            html += "<tr><td>protocolType</td><td>"+ protocolTypeDesc[protocolType]+"</td></tr>";

            var serverConfigTable = $("#server_config_table");
            serverConfigTable.html(html);
        }
    }


    function initActionMap(){
        $.ajax({
            type: "GET",
            headers: {
                "X-Token":playerList[GetPlayerNameByIndex(1)].token,
            },
            url:actionMapHostUri,
            success: function(dataActionMap){
                ServerConfig.actionMap = dataActionMap.data;

                for (var i=1;i<=playerMax;i++){
                    var playerInfo = playerList[GetPlayerNameByIndex(i)];
                    initPlayer(playerInfo,"p"+i,ServerConfig);
                }
            }
        });
    }

    function init(){
        playerLogin();
        initServerConfig();
    }


    function initPlayer(player,divId,data){
        //创建一个玩家相关的所有DIV的ID，主要是ID 是由前缀+PID 动态生成 的
        var DomIdPreObj = getPlayerDomIdPreObj(player.id);
        DomIdPreObj.playerId = player.id;

        var wsObj = new Sync(player.id, player.token, data, DomIdPreObj,contentType,protocolType);

        var html = getTemplateHtml();
        html = ReplaceTemplateHtml(html,DomIdPreObj);
        $("#"+divId).html(html);
        $("#"+DomIdPreObj.optBntId).click(wsObj.create);

        $("#"+DomIdPreObj.moveUp).click("up",wsObj.move);
        $("#"+DomIdPreObj.moveLeft).click("left",wsObj.move);
        $("#"+DomIdPreObj.moveRight).click("right",wsObj.move);
        $("#"+DomIdPreObj.moveDown).click("down",wsObj.move);

        wsObj.getMap("mapId_"+player.id);
    }

    function getPlayerDomIdPreObj(pid){
        var rrVV = {
            "seqId":domIdPre.seq+pid,
            "roomId":domIdPre.room+pid,
            "mapId":domIdPre.map +pid,
            "optBntId":domIdPre.optBnt+pid,
            "randSeekId":domIdPre.randSeek+pid,
            "moveUp":domIdPre.moveUp+pid,
            "moveLeft":domIdPre.moveLeft+pid,
            "moveRight":domIdPre.moveRight+pid,
            "moveDown":domIdPre.moveDown+pid,
        };
        return rrVV;
    }

    function ReplaceTemplateHtml(html,DomIdPreObj){
        for(let key  in DomIdPreObj){
            html = html.replace("{{"+key +"}}",DomIdPreObj[key]);
        }
        return html;
    }

    function getTemplateHtml(){
        var html  = '<table>\n' +
            '    <tr>\n' +
            '        <td>seqId:<span id="{{seqId}}"></span></td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td>roomId：<span id="{{roomId}}" ></span></td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td>randSeek：<span id="{{randSeekId}}" ></span></td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td>绿色:自己</td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td>红色:对方</td>\n' +
            '    </tr>\n' +
            '    <tr>\n' +
            '        <td width="50%">\n' +
            '            <div>\n' +
            '                player_{{playerId}}\n' +
            '            </div>\n' +
            '            <table id="{{mapId}}"></table>\n' +
            '\n' +
            '            <table>\n' +
            '                <tr>' +
            '                   <td></td>' +
            '                   <td id="{{moveUp}}"><a href="javascript:void(0)"  >上</a></td><td></td>' +
            '                </tr>\n' +
            '                <tr>' +
            '                   <td id="{{moveLeft}}"><a href="javascript:void(0)"  >左</a></td><td></td>' +
            '                   <td id="{{moveRight}}"><a href="javascript:void(0)"  >右</a></td>' +
            '                </tr>\n' +
            '                <tr>' +
            '                   <td></td>' +
            '                   <td id="{{moveDown}}"><a href="javascript:void(0)"  >下</a></td><td></td>' +
            '                </tr>\n' +
            '            </table>\n' +
            '\n' +
            '            <div>\n' +
            '                <div id="{{optBntId}}">\n' +
            '                    <a href="javascript:void(0);">连接</a>\n' +
            '                </div>\n' +
            '\n' +
            '            </div>\n' +
            '        </td>\n' +
            '\n' +
            '    </tr>\n' +
            '</table>';
        return html;
    }

    function intToByte(i) {
        var b = i & 0xFF;
        var c = 0;
        if (b >= 128) {
            c = b % 128;
            c = -1 * (128 - c);
        } else {
            c = b;
        }
        return c;
    }

    init();

</script>


</html>